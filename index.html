<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#fff6c9">
<title>지니짱 감사일기</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.png" sizes="192x192">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Jua&family=Gowun+Dodum&display=swap" rel="stylesheet">
<style>
:root{--bg:#fffaf0;--header1:#ffefad;--header2:#fff6c9;--card:#ffffff;--ink:#3a2e39;--muted:#8b7f86;--brand:#f5d76e;--danger:#ff88a3;--line:#f1e7d7}
*{box-sizing:border-box}html{-webkit-text-size-adjust:100%}
body{margin:0;background:linear-gradient(180deg,#fff7ee,var(--bg) 35%);color:var(--ink);font-family:'Gowun Dodum',system-ui,-apple-system,'Noto Sans KR',sans-serif}
h1,h2,h3{font-family:'Jua','Gowun Dodum',sans-serif;margin:.2rem 0 .6rem}
.hidden{display:none}
.app-header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--header1),var(--header2) 60%);border-bottom:1px solid rgba(0,0,0,.05);padding:.8rem .9rem}
.title-area{max-width:900px;margin:0 auto;display:flex;align-items:flex-end;justify-content:space-between;gap:.75rem;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:.55rem;font-size:clamp(1.15rem,4.2vw,1.6rem);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.logo:before{content:'✶';font-size:1.1rem;color:#f5c518;filter:drop-shadow(0 1px 0 rgba(0,0,0,.12))}
.header-right{display:flex;flex-direction:column;gap:.55rem;align-items:flex-end}
.header-auth{display:flex;align-items:center;gap:.55rem}
.mini-btn{padding:.35rem .6rem;border:1px solid var(--line);border-radius:.65rem;background:#fff;font-weight:700}
.tabs{display:flex;gap:.75rem;flex-wrap:wrap}
.tab-btn{flex:1 1 120px;text-align:center;text-decoration:none;color:inherit;padding:.65rem .9rem;border:1px solid var(--line);background:#fff;border-radius:.9rem;font-weight:700}
.tab-btn.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(245,215,110,.24)}
main{padding:1rem;max-width:900px;margin:0 auto}
.page{display:none}
.page.active{display:block}
.date-row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-bottom:.6rem}
#weekPicker{position:absolute;left:-9999px;width:1px;height:1px;opacity:0}
#dailyDateQuick{display:none}
.date-text{margin-left:auto;font-weight:700;color:#2563eb}
.date-text.nice{color:#7c3aed}
.card{background:var(--card);border:1px solid var(--line);border-radius:1rem;padding:1rem;margin:1rem 0;box-shadow:0 6px 18px rgba(0,0,0,.06)}
.lbl{display:block;font-weight:700;margin:.5rem 0 .25rem}
textarea,input[type=text],input[type=email],input[type=password],input[type=date],input[type=week]{width:100%;padding:.85rem;border:1px solid var(--line);border-radius:.75rem;font-size:1.02rem;background:#fff;font-family:'Gowun Dodum','Jua',sans-serif}
::placeholder{opacity:.6;font-family:'Gowun Dodum','Jua',sans-serif}
textarea{min-height:96px;resize:vertical}
.gratitude-list{margin:.25rem 0 .5rem 1rem}
.btn-row{display:flex;gap:1rem;flex-wrap:wrap}
.actions-spaced{gap:1rem;row-gap:1rem}
.btn{padding:.65rem .95rem;border:1px solid var(--line);border-radius:.9rem;background:#fff;font-weight:700;cursor:pointer}
.btn.primary{background:var(--brand);color:#000;border-color:var(--brand)}
.btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
.btn.outline{background:#fff}
.btn.link{background:transparent;border:none;padding:.2rem 0;text-decoration:underline;cursor:pointer}
.add-mission{display:flex;gap:.5rem;margin-top:.5rem}
.mission-item{display:flex;gap:.5rem;align-items:center;border:1px solid var(--line);padding:.5rem;border-radius:.75rem;margin:.25rem 0;background:#fff}
.mission-item input[type=text]{flex:1;border:none;padding:.5rem;background:transparent}
.mission-item input[type=checkbox]{transform:scale(1.2)}
.app-footer{padding:1.2rem;text-align:center;color:var(--muted)}
.row{display:flex;gap:.5rem;align-items:center;margin:.5rem 0}
.muted{color:var(--muted)}
/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50;padding:1rem;pointer-events:none}
.modal.open{display:flex!important;pointer-events:auto}
.modal-panel{width:min(520px,95vw);background:#fff;border-radius:1rem;padding:1rem;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.modal-panel h3{margin:.25rem 0 1rem;font-size:1.25rem}
.modal-actions{gap:12px}
@media (max-width:380px){.modal-actions{flex-direction:column}.modal-actions .btn{width:100%}}
#loginMsg{margin-top:.5rem;color:#d02;font-weight:700}
.settings-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.8rem}
.file-wrap{position:relative;overflow:hidden;display:inline-block;text-align:center}
.file-wrap input[type=file]{position:absolute;left:0;top:0;opacity:0;width:100%;height:100%;cursor:pointer}
#fileName{margin-top:.3rem}
</style>
<!-- Firebase compat (간단 연결) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<header class="app-header">
  <div class="title-area">
    <h1 class="logo">지니짱 감사일기</h1>
    <div class="header-right">
      <div class="header-auth">
        <span id="authMiniState" class="muted">로그아웃 상태</span>
        <button id="authMiniLogin" class="mini-btn">로그인</button>
      </div>
      <nav class="tabs">
        <a href="#/daily" class="tab-btn" id="tab-daily">데일리</a>
        <a href="#/weekly" class="tab-btn" id="tab-weekly">위클리</a>
        <a href="#/search" class="tab-btn" id="tab-search">검색</a>
        <a href="#/settings" class="tab-btn" id="tab-settings">설정/백업</a>
      </nav>
    </div>
  </div>
</header>
<main id="app-main">
  <section id="page-daily" class="page">
    <div class="date-row">
      <button id="prevDay" class="btn">&lt;</button>
      <input type="date" id="dailyDate">
      <button id="nextDay" class="btn">&gt;</button>
      <button id="todayBtn" class="btn outline">오늘</button>
      <span id="dailyDateText" class="date-text"></span>
    </div>
    <div class="card">
      <h2>🪞 오늘의 질문</h2>
      <div class="qbox">
        <textarea id="questionText" class="auto" readonly placeholder="질문이 준비되는 중입니다…"></textarea>
        <div class="btn-row actions-spaced">
          <button id="btnAnotherQ" class="btn">다른 질문</button>
        </div>
      </div>
      <label class="lbl">답변</label>
      <textarea id="answerText" class="auto" placeholder="질문에 대한 나의 답을 적어보세요."></textarea>
    </div>
    <div class="card">
      <h2>🧠 감정일기</h2>
      <p class="muted">사건을 사실대로 적고, 그때의 생각과 감정을 구분해 본 뒤 결과를 간단히 남겨보세요.</p>
      <label class="lbl">사건</label>
      <textarea id="eventField" class="auto" placeholder="오늘 무슨 일이 있었나요?"></textarea>
      <label class="lbl">생각</label>
      <textarea id="thoughtField" class="auto" placeholder="그때 어떤 생각이 들었나요?"></textarea>
      <label class="lbl">감정</label>
      <textarea id="feelingField" class="auto" placeholder="감정의 강도/이유를 함께 적어보세요."></textarea>
      <label class="lbl">결과</label>
      <textarea id="resultField" class="auto" placeholder="그 결과 나는 어떻게 행동했나요?"></textarea>
    </div>
    <div class="card">
      <h2>🌼 감사일기</h2>
      <ol class="gratitude-list">
        <li><input type="text" id="grat1" placeholder="작은 것도 좋아요."></li>
        <li><input type="text" id="grat2" placeholder="사람/행동/행운 등 무엇이든."></li>
        <li><input type="text" id="grat3" placeholder="오늘을 좋게 만든 것."></li>
      </ol>
    </div>
    <div class="card">
      <h2>📔 일상일기</h2>
      <textarea id="dailyNote" class="auto" placeholder="짧게 요약하거나, 길게 자유롭게 적어도 좋아요."></textarea>
    </div>
    <div class="card">
      <h2>🏷️ 태그</h2>
      <input type="text" id="tagsField" placeholder="#가족, #업무 처럼 쉼표로 구분">
    </div>
    <div class="btn-row end actions-spaced" id="dailyActions">
      <button id="saveDaily" class="btn primary">저장</button>
      <button id="clearDaily" class="btn danger">지우기</button>
      <span id="statusDaily" class="muted">불러옴</span>
    </div>
  </section>

  <section id="page-weekly" class="page">
    <div class="date-row">
      <button id="prevWeek" class="btn">&lt;</button>
      <input type="week" id="weekPicker">
      <button id="nextWeek" class="btn">&gt;</button>
      <button id="thisWeekBtn" class="btn outline">이번 주</button>
      <span id="weekText" class="date-text"></span>
      <span id="weekTextNice" class="date-text nice"></span>
    </div>
    <div class="card">
      <h2>✅ 미션 (체크박스)</h2>
      <div id="missionList"></div>
      <div class="add-mission">
        <input type="text" id="newMission" placeholder="미션 추가">
        <button id="addMission" class="btn">+ 추가</button>
      </div>
    </div>
    <div class="card">
      <h2>🫶 오늘의 문구</h2>
      <textarea id="healingText" class="auto" placeholder="오늘의 문구"></textarea>
      <div class="btn-row actions-spaced">
        <button id="randomHealing" class="btn">랜덤</button>
        <button id="saveWeekly" class="btn primary">저장</button>
        <button id="clearWeekly" class="btn danger">지우기</button>
      </div>
      <button id="startCopy" class="btn link">✍️ 필사 시작</button>
      <textarea id="copyArea" class="auto hidden" placeholder="문구를 따라 적어보세요."></textarea>
    </div>
  </section>

  <section id="page-search" class="page">
    <div class="card">
      <h2>🔎 검색</h2>
      <input type="text" id="searchInput" placeholder="키워드 또는 #태그 (예: 보고서, #업무)">
      <div class="btn-row actions-spaced">
        <button id="searchBtn" class="btn">검색</button>
        <button id="searchClear" class="btn">지우기</button>
      </div>
    </div>
    <div class="card">
      <h3>결과</h3>
      <div id="searchResults"></div>
    </div>
  </section>

  <section id="page-settings" class="page">
    <div class="card">
      <h2>🔐 로그인</h2>
      <div class="btn-row actions-spaced">
        <button id="openLogin" class="btn">로그인</button>
        <button id="btnSignOut" class="btn outline">로그아웃</button>
      </div>
      <p class="muted" id="authState">로그아웃 상태</p>
    </div>
    <div class="card">
      <h2>📦 백업/복원</h2>
      <div class="settings-grid">
        <button id="exportJSON" class="btn">JSON 파일로 저장</button>
        <button id="shareJSON" class="btn">JSON 공유(카톡 등)</button>
        <label class="file-wrap btn"><input type="file" id="importFile" accept=".json">파일 선택</label>
        <button id="importJSON" class="btn">JSON 가져오기</button>
        <button id="refreshCache" class="btn outline">캐시 새로고침(업데이트)</button>
        <button id="resetLocal" class="btn danger">로컬 데이터 초기화</button>
      </div>
      <p id="fileName" class="muted"></p>
    </div>
  </section>
</main>

<footer class="app-footer">
  <small>오프라인 + 로그인 연결 · v2.6.2</small>
</footer>

<div id="loginModal" class="modal"><div class="modal-panel">
  <h3>로그인</h3>
  <label class="lbl">이메일</label><input type="email" id="loginEmail" placeholder="you@example.com">
  <label class="lbl">비밀번호</label><input type="password" id="loginPwd" placeholder="••••••••">
  <div class="btn-row actions-spaced modal-actions">
    <button id="modalSignIn" class="btn primary">로그인</button>
    <button id="modalSignUp" class="btn">회원가입</button>
    <button id="modalClose" class="btn">닫기</button>
  </div>
  <p id="loginMsg" class="muted"></p>
</div></div>

<script>
// ---------- helpers
const $ = (sel, el=document)=>el.querySelector(sel);
const $$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
const fmtYMD = d => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
const weekOfYear = d => { const t = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const dayNum = (t.getUTCDay() + 6) % 7; t.setUTCDate(t.getUTCDate() - dayNum + 3); const firstThursday = new Date(Date.UTC(t.getUTCFullYear(),0,4)); const diff = (t - firstThursday) / 86400000; return 1 + Math.floor(diff / 7); };
const weekOfMonth = d => Math.ceil((d.getDate() + (new Date(d.getFullYear(), d.getMonth(), 1).getDay()+6)%7) / 7);

// ---------- routing
function showPage(id){
  $$('.page').forEach(p=>{ p.classList.remove('active'); p.classList.remove('default'); p.style.display='none'; });
  const page = document.getElementById('page-'+id);
  if(page){ page.classList.add('active'); page.style.display='block'; }
  $$('.tab-btn').forEach(t=>t.classList.remove('active'));
  const tab = document.getElementById('tab-'+id); if(tab) tab.classList.add('active');
  if(id==='weekly') updateWeekTexts();
}
function onHash(){ const id=(location.hash.replace('#/','')||'daily'); showPage(/^(daily|weekly|search|settings)$/.test(id)?id:'daily'); }
window.addEventListener('hashchange', onHash);
// 강제 탭 라우팅(해시 이벤트 누락 방지)
document.addEventListener('click', (e)=>{
  const a = e.target.closest && e.target.closest('a.tab-btn');
  if(!a) return;
  e.preventDefault();
  const id = a.id.replace('tab-','');
  showPage(id);
  if(location.hash !== '#/'+id){ location.hash = '#/'+id; }
});

// ---------- questions & daily store
const QUESTIONS = ['오늘 나는 무엇을 잘했나요?','사람들에게 어떤 사람으로 기억되고 싶나요?','오늘 나를 웃게 만든 순간은 무엇이었나요?','요즘 나를 설레게 하는 작은 일은?','지금의 나에게 필요한 한 문장은?','오늘 배운 것 하나는 무엇인가요?','오늘 나를 힘나게 한 고마운 사람은?','지금 감사한 것 세 가지는?','오늘 놓아도 되는 걱정은?'];
const STORE = (key,val)=> val===undefined ? JSON.parse(localStorage.getItem(key)||'null') : localStorage.setItem(key, JSON.stringify(val));
function currentKey(){ const d=$('#dailyDate').value; return `td:v2:daily:${d}`; }
async function saveDaily(){ const data = {q: $('#questionText').value, a: $('#answerText').value, e: $('#eventField').value, t: $('#thoughtField').value, f: $('#feelingField').value, r: $('#resultField').value, g1: $('#grat1').value, g2: $('#grat2').value, g3: $('#grat3').value, note: $('#dailyNote').value, tags: $('#tagsField').value}; STORE(currentKey(), data); let msg='저장 완료!'; try{ const ok=await cloudSaveDaily(); if(ok) msg='저장 완료(클라우드 동기화)!'; }catch(e){} alert(msg); }
async function loadDaily(){ 
  if(await cloudLoadDaily()) return;
  const data = STORE(currentKey()); if(!data) return; 
  $('#questionText').value = data.q||''; $('#answerText').value=data.a||''; $('#eventField').value=data.e||''; $('#thoughtField').value=data.t||''; $('#feelingField').value=data.f||''; $('#resultField').value=data.r||''; $('#grat1').value=data.g1||''; $('#grat2').value=data.g2||''; $('#grat3').value=data.g3||''; $('#dailyNote').value=data.note||''; $('#tagsField').value=data.tags||''; $('#statusDaily').textContent='불러옴'; }
function clearDaily(){ if(confirm('이 날짜의 내용을 지울까요?')){ localStorage.removeItem(currentKey()); $$('textarea,input[type=text]').forEach(el=>{ if(el.id.startsWith('grat')||el.id.endsWith('Text')||el.id.endsWith('Field')||el.id==='dailyNote'||el.id==='tagsField') el.value=''; }); } }
function moveDay(delta){ const d=new Date($('#dailyDate').value||Date.now()); d.setDate(d.getDate()+delta); $('#dailyDate').value=fmtYMD(d); $('#dailyDateText').textContent=`${d.getFullYear()}. ${d.getMonth()+1}. ${d.getDate()}.`; loadDaily(); }
function anotherQ(){ const cur=$('#questionText').value; let cand; let tries=0; do{ cand = QUESTIONS[Math.floor(Math.random()*QUESTIONS.length)]; tries++; }while(cand===cur && tries<5); $('#questionText').value=cand; }

// ---------- weekly
let _weekAnchor = new Date(); // state anchor for weekly view (any day within target week)
function updateWeekTexts(){ 
  const d = _weekAnchor;
  const wy = weekOfYear(d);
  $('#weekText').textContent = `${d.getFullYear()} ${String(wy)}번째 주`;
  $('#weekTextNice').textContent = `${d.getFullYear()}년 ${d.getMonth()+1}월 ${weekOfMonth(d)}주`;
}
function thisWeek(){ _weekAnchor = new Date(); updateWeekTexts(); }
// 안전한 미션 추가(문자열/HTML 주입 방지)
function addMissionItem(text){ const box=document.createElement('div'); box.className='mission-item'; const cb=document.createElement('input'); cb.type='checkbox'; const input=document.createElement('input'); input.type='text'; input.value=text||''; const del=document.createElement('button'); del.className='btn'; del.textContent='삭제'; del.addEventListener('click', ()=>box.remove()); box.append(cb, input, del); $('#missionList').appendChild(box); }

// ---------- search
function doSearch(){ const q = $('#searchInput').value.trim(); const res = $('#searchResults'); res.innerHTML=''; if(!q){ res.textContent='검색어를 입력하세요.'; return; } const keys = Object.keys(localStorage).filter(k=>k.startsWith('td:v2:daily:')); const items = []; keys.forEach(k=>{ const d = JSON.parse(localStorage.getItem(k)||'null'); if(!d) return; const text = [d.q,d.a,d.e,d.t,d.f,d.r,d.g1,d.g2,d.g3,d.note,d.tags].join(' '); if(text.includes(q)){ items.push({date:k.split(':').pop(), text:d.q||''}); } }); if(!items.length){ res.textContent='결과 없음'; return; } res.innerHTML = items.map(it=>`<div class="mission-item"><strong>${it.date}</strong><span style="margin-left:.5rem">${it.text}</span></div>`).join(''); }

// ---------- modal open/close
document.addEventListener('click', e=>{
  const id = e.target.id;
  if(id==='saveDaily') return void saveDaily();
  if(id==='clearDaily') return void clearDaily();
  if(id==='btnAnotherQ') return void anotherQ();
  if(id==='prevDay') return void moveDay(-1);
  if(id==='nextDay') return void moveDay(1);
  if(id==='todayBtn'){ const now=new Date(); $('#dailyDate').value=fmtYMD(now); $('#dailyDateText').textContent=`${now.getFullYear()}. ${now.getMonth()+1}. ${now.getDate()}.`; loadDaily(); return; }
  if(id==='searchBtn') return void doSearch();
  if(id==='searchClear'){ $('#searchInput').value=''; $('#searchResults').textContent=''; return; }
  if(id==='thisWeekBtn') return void thisWeek();
  if(id==='prevWeek'){ _weekAnchor = new Date(_weekAnchor.getFullYear(), _weekAnchor.getMonth(), _weekAnchor.getDate()-7); updateWeekTexts(); return; }
  if(id==='nextWeek'){ _weekAnchor = new Date(_weekAnchor.getFullYear(), _weekAnchor.getMonth(), _weekAnchor.getDate()+7); updateWeekTexts(); return; }
  if(id==='randomHealing'){ const arr=['부러움 대신 배움을 고르면 마음은 가벼워진다.','작은 친절 하나가 하루를 바꾼다.','완벽보다 지속이 더 멀리 간다.','오늘의 나를 어제의 나와만 비교하자.']; $('#healingText').value = arr[Math.floor(Math.random()*arr.length)]; return; }
  if(id==='saveWeekly'){ (async()=>{ let m='저장 완료!'; try{ const ok=await cloudSaveWeekly(); if(ok) m='저장 완료(클라우드 동기화)!'; }catch(e){} alert(m); })(); return; }
  if(id==='clearWeekly'){ $('#healingText').value=''; $('#missionList').innerHTML=''; return; }
  if(id==='startCopy'){ $('#copyArea').classList.toggle('hidden'); return; }
  if(id==='addMission'){ const v=$('#newMission').value.trim(); if(!v) return; addMissionItem(v); $('#newMission').value=''; return; }

  if(id==='openLogin' || id==='authMiniLogin'){ $('#loginModal').classList.add('open'); return; }
  if(id==='modalClose'){ $('#loginModal').classList.remove('open'); return; }
});
// 배경 탭 닫기
$('#loginModal').addEventListener('click', (e)=>{ if(e.target.id==='loginModal'){ e.currentTarget.classList.remove('open'); }});
// ESC 닫기
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ const m=$('#loginModal'); if(m.classList.contains('open')) m.classList.remove('open'); } });

// ---------- inputs
document.addEventListener('input', e=>{ if(e.target.matches('textarea.auto')){ e.target.style.height='auto'; e.target.style.height=(e.target.scrollHeight+2)+'px'; } });
document.addEventListener('change', e=>{ if(e.target.id==='dailyDate'){ const d=new Date(e.target.value); $('#dailyDateText').textContent=`${d.getFullYear()}. ${d.getMonth()+1}. ${d.getDate()}.`; loadDaily(); } });

// ---------- init
document.addEventListener('DOMContentLoaded', ()=>{
  // date + question
  const now = new Date(); const dInput = $('#dailyDate'); if(dInput && !dInput.value) dInput.value = fmtYMD(now); const dText = $('#dailyDateText'); if(dText && !dText.textContent) dText.textContent = `${now.getFullYear()}. ${now.getMonth()+1}. ${now.getDate()}.`; const q = $('#questionText'); if(q && !q.value) q.value = QUESTIONS[Math.floor(Math.random()*QUESTIONS.length)];
  // route
  if(!location.hash) location.hash = '#/daily';
  onHash();
  // weekly defaults
  thisWeek();
});


// ---------- Firestore Cloud Sync
let _auth=null, _db=null;
async function cloudSaveDaily(){
  if(!_auth || !_auth.currentUser || !_db) return false;
  const uid=_auth.currentUser.uid;
  const dateKey=($('#dailyDate').value);
  const docRef = _db.collection('users').doc(uid).collection('daily').doc(dateKey);
  const payload = { q: $('#questionText').value, a: $('#answerText').value, e: $('#eventField').value, t: $('#thoughtField').value, f: $('#feelingField').value, r: $('#resultField').value, g1: $('#grat1').value, g2: $('#grat2').value, g3: $('#grat3').value, note: $('#dailyNote').value, tags: $('#tagsField').value, updatedAt: new Date() };
  await docRef.set(payload, {merge:true});
  return true;
}
async function cloudLoadDaily(){
  if(!_auth || !_auth.currentUser || !_db) return false;
  const uid=_auth.currentUser.uid;
  const dateKey=($('#dailyDate').value);
  const snap = await _db.collection('users').doc(uid).collection('daily').doc(dateKey).get();
  if(!snap.exists) return false;
  const d=snap.data();
  $('#questionText').value = d.q||''; $('#answerText').value=d.a||''; $('#eventField').value=d.e||''; $('#thoughtField').value=d.t||''; $('#feelingField').value=d.f||''; $('#resultField').value=d.r||''; $('#grat1').value=d.g1||''; $('#grat2').value=d.g2||''; $('#grat3').value=d.g3||''; $('#dailyNote').value=d.note||''; $('#tagsField').value=d.tags||'';
  $('#statusDaily').textContent='클라우드에서 불러옴';
  return true;
}
function isoWeekKey(d){ return d.getFullYear() + '-W' + String(weekOfYear(d)).padStart(2,'0'); }
async function cloudSaveWeekly(){
  if(!_auth || !_auth.currentUser || !_db) return false;
  const uid=_auth.currentUser.uid;
  const key=isoWeekKey(_weekAnchor);
  const missions = Array.from(document.querySelectorAll('#missionList .mission-item')).map(mi=>({done: mi.querySelector('input[type=checkbox]').checked, text: mi.querySelector('input[type=text]').value||''}));
  const payload = { weekAnchor: _weekAnchor, weekText: $('#weekText').textContent, weekTextNice: $('#weekTextNice').textContent, healing: $('#healingText').value||'', missions, updatedAt:new Date() };
  await _db.collection('users').doc(uid).collection('weekly').doc(key).set(payload, {merge:true});
  return true;
}
async function cloudLoadWeekly(){
  if(!_auth || !_auth.currentUser || !_db) return false;
  const uid=_auth.currentUser.uid;
  const key=isoWeekKey(_weekAnchor);
  const ref=_db.collection('users').doc(uid).collection('weekly').doc(key);
  const snap=await ref.get();
  if(!snap.exists) return false;
  const d=snap.data(); $('#healingText').value=d.healing||''; $('#missionList').innerHTML=''; (d.missions||[]).forEach(m=>{ addMissionItem(m.text||''); const last=document.querySelector('#missionList .mission-item:last-child'); if(last){ last.querySelector('input[type=checkbox]').checked=!!m.done; } }); return true;
}

// ---------- Firebase auth (compat)
const firebaseConfig = {
  apiKey: "AIzaSyAOqrdA0aHL5lMXOOmdtj8mnLi6zgSXoiM",
  authDomain: "thanksdiary-dca35.firebaseapp.com",
  projectId: "thanksdiary-dca35",
  storageBucket: "thanksdiary-dca35.firebasestorage.app",
  messagingSenderId: "250477396044",
  appId: "1:250477396044:web:aa1cf155f01263e08834e9",
  measurementId: "G-J0Z03LHYYC"
};
try{
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  _auth = auth; _db = db;

  // 상태 표시
  auth.onAuthStateChanged((user)=>{
    const txt = user ? (user.email||'')+' 로그인됨' : '로그아웃 상태';
    $('#authMiniState').textContent = txt;
    $('#authState').textContent = txt;
  });

  // 로그인/회원가입/로그아웃
  $('#modalSignIn').addEventListener('click', async ()=>{
    try{
      await auth.signInWithEmailAndPassword($('#loginEmail').value.trim(), $('#loginPwd').value);
      $('#loginMsg').textContent='로그인 성공!';
      $('#loginModal').classList.remove('open');
    }catch(err){
      $('#loginMsg').textContent='로그인 실패: '+(err.message||err);
    }
  });
  $('#modalSignUp').addEventListener('click', async ()=>{
    try{
      await auth.createUserWithEmailAndPassword($('#loginEmail').value.trim(), $('#loginPwd').value);
      $('#loginMsg').textContent='회원가입 완료!';
      $('#loginModal').classList.remove('open');
    }catch(err){
      $('#loginMsg').textContent='회원가입 실패: '+(err.message||err);
    }
  });
  $('#btnSignOut').addEventListener('click', async ()=>{
    try{ await auth.signOut(); alert('로그아웃 되었습니다.'); }catch(e){ alert('로그아웃 오류'); }
  });
}catch(e){
  console.warn('Firebase init error', e);
  $('#loginMsg').textContent='Firebase 초기화 오류';
}
</script>
</body>
</html>
