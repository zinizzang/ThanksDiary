<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#fff6c9">
  <title>지니짱 감사일기</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jua&family=Gowun+Dodum&display=swap" rel="stylesheet">
  <style>
  
:root{
  --bg:#fffaf0; --header1:#ffefad; --header2:#fff6c9; --card:#ffffff;
  --ink:#3a2e39; --muted:#8b7f86; --brand:#f5d76e; --danger:#ff88a3; --line:#f1e7d7;
}
*{box-sizing:border-box}
html{ -webkit-text-size-adjust:100%; }
body{ margin:0;padding:0; background:linear-gradient(180deg,#fff7ee,var(--bg) 35%); color:var(--ink);
  font-family:'Gowun Dodum', system-ui, -apple-system, 'Noto Sans KR', sans-serif; }
h1,h2,h3{ font-family:'Jua','Gowun Dodum',sans-serif; letter-spacing:.2px; margin:.2rem 0 .6rem }
.hidden{display:none}
.app-header{ position:sticky; top:0; z-index:10; background:linear-gradient(90deg,var(--header1),var(--header2) 60%);
  border-bottom:1px solid rgba(0,0,0,.05); padding:.8rem .9rem; }
.title-area{max-width:900px;margin:0 auto; display:flex; align-items:flex-end; justify-content:space-between; gap:.75rem; flex-wrap:wrap;}
.logo{display:flex; align-items:center; gap:.55rem; font-size: clamp(1.15rem, 4.2vw, 1.6rem); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.logo:before{ content:'✶'; font-size:1.1rem; color:#f5c518; filter:drop-shadow(0 1px 0 rgba(0,0,0,.12)); }
.header-right{display:flex; flex-direction:column; gap:.55rem; align-items:flex-end}
.header-auth{ display:flex; align-items:center; gap:.55rem; }
.mini-btn{ padding:.35rem .6rem; border:1px solid var(--line); border-radius:.65rem; background:#fff; font-weight:700; }
.tabs{display:flex; gap:.75rem; flex-wrap:wrap}
.tab-btn{ flex:1 1 120px; text-align:center; text-decoration:none; color:inherit; padding:.65rem .9rem; border:1px solid var(--line); background:#fff; border-radius:.9rem; font-weight:700;}
.tab-btn.active{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(245,215,110,.24); }
main{padding:1rem;max-width:900px;margin:0 auto}
.page{ display:none } .page.active, .page.default{ display:block }
.date-row{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom:.6rem}
.date-text{margin-left:auto; font-weight:700; color:#2563eb}
.date-text.nice{ color:#7c3aed; }
.card{ background:var(--card); border:1px solid var(--line); border-radius:1rem; padding:1rem; margin:1rem 0; box-shadow:0 6px 18px rgba(0,0,0,.06) }
.lbl{display:block; font-weight:700; margin:.5rem 0 .25rem}
textarea, input[type="text"], input[type="email"], input[type="password"], input[type="date"], input[type="week"]{ width:100%; padding:.85rem; border:1px solid var(--line);
  border-radius:.75rem; font-size:1.02rem; background:#fff; font-family:'Gowun Dodum','Jua',sans-serif; }
::placeholder{opacity:.6; font-family:'Gowun Dodum','Jua',sans-serif}
textarea{min-height:96px; resize:vertical}
.qbox textarea[readonly]{background:#fffdf5}
.gratitude-list{margin:.25rem 0 .5rem 1rem}
.btn-row{display:flex; gap:1rem; flex-wrap:wrap}
.actions-spaced{gap:1rem; row-gap:1rem}
.btn{ padding:.65rem .95rem; border:1px solid var(--line); border-radius:.9rem; background:#fff; font-weight:700; cursor:pointer; }
.btn.primary{background:var(--brand); color:#000; border-color:var(--brand)}
.btn.danger{background:var(--danger); color:#fff; border-color:var(--danger)}
.btn.outline{background:#fff}
.btn.link{background:transparent; border:none; padding:.2rem 0; text-decoration:underline; cursor:pointer}
.add-mission{display:flex; gap:.5rem; margin-top:.5rem}
.mission-item{display:flex; gap:.5rem; align-items:center; border:1px solid var(--line); padding:.5rem; border-radius:.75rem; margin:.25rem 0; background:#fff}
.mission-item input[type="text"]{flex:1; border:none; padding:.5rem; background:transparent}
.mission-item input[type="checkbox"]{transform:scale(1.2)}
.app-footer{padding:1.2rem; text-align:center; color:var(--muted)}
.row{display:flex; gap:.5rem; align-items:center; margin:.5rem 0}
.muted{color:var(--muted)}
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50; padding:1rem; }
.modal.open{ display:flex; }
.modal-panel{ width:min(520px, 95vw); background:#fff; border-radius:1rem; padding:1rem; box-shadow:0 10px 30px rgba(0,0,0,.25); }
.modal-panel h3{ margin:.25rem 0 1rem; font-size:1.25rem; }
.modal-actions{ gap:12px; }
@media (max-width: 380px){
  .modal-actions{ flex-direction:column; }
  .modal-actions .btn{ width:100%; }
}
#loginMsg{ margin-top:.5rem; color:#d02; font-weight:700; }
.settings-grid{ display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:.8rem; }
.file-wrap{ position:relative; overflow:hidden; display:inline-block; text-align:center; }
.file-wrap input[type="file"]{ position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer; }
#fileName{ margin-top:.3rem; }

  </style>
</head>
<body>
  <header class="app-header">
    <div class="title-area">
      <h1 class="logo">지니짱 감사일기</h1>
      <div class="header-right">
        <div class="header-auth">
          <span id="authMiniState" class="muted">로그아웃 상태</span>
          <button id="authMiniLogin" class="mini-btn">로그인</button>
          <button id="authMiniLogout" class="mini-btn hidden">로그아웃</button>
        </div>
        <nav class="tabs">
          <a href="#/daily" class="tab-btn" id="tab-daily">데일리</a>
          <a href="#/weekly" class="tab-btn" id="tab-weekly">위클리</a>
          <a href="#/search" class="tab-btn" id="tab-search">검색</a>
          <a href="#/settings" class="tab-btn" id="tab-settings">설정/백업</a>
        </nav>
      </div>
    </div>
  </header>

  <main id="app-main">
    <section id="page-daily" class="page default">
      <div class="date-row">
        <button id="prevDay" class="btn">&lt;</button>
        <input type="date" id="dailyDate">
        <button id="nextDay" class="btn">&gt;</button>
        <button id="todayBtn" class="btn outline">오늘</button>
        <span id="dailyDateText" class="date-text"></span>
      </div>
      <div class="card">
        <h2>🪞 오늘의 질문</h2>
        <div class="qbox">
          <textarea id="questionText" class="auto" readonly placeholder="질문이 준비되는 중입니다…"></textarea>
          <div class="q-actions actions-spaced">
            <button id="btnAnotherQ" class="btn">다른 질문</button>
          </div>
        </div>
        <label class="lbl">답변</label>
        <textarea id="answerText" class="auto" placeholder="질문에 대한 나의 답을 적어보세요."></textarea>
      </div>
      <div class="card">
        <h2>🧠 감정일기</h2>
        <p class="muted">사건을 사실대로 적고, 그때의 생각과 감정을 구분해 본 뒤 결과를 간단히 남겨보세요.</p>
        <label class="lbl">사건</label>
        <textarea id="eventField" class="auto" placeholder="오늘 무슨 일이 있었나요?"></textarea>
        <label class="lbl">생각</label>
        <textarea id="thoughtField" class="auto" placeholder="그때 어떤 생각이 들었나요?"></textarea>
        <label class="lbl">감정</label>
        <textarea id="feelingField" class="auto" placeholder="감정의 강도/이유를 함께 적어보세요."></textarea>
        <label class="lbl">결과</label>
        <textarea id="resultField" class="auto" placeholder="그 결과 나는 어떻게 행동했나요?"></textarea>
      </div>
      <div class="card">
        <h2>🌼 감사일기</h2>
        <ol class="gratitude-list">
          <li><input type="text" id="grat1" placeholder="작은 것도 좋아요."></li>
          <li><input type="text" id="grat2" placeholder="사람/행동/행운 등 무엇이든."></li>
          <li><input type="text" id="grat3" placeholder="오늘을 좋게 만든 것."></li>
        </ol>
      </div>
      <div class="card">
        <h2>📔 일상일기</h2>
        <textarea id="dailyNote" class="auto" placeholder="짧게 요약하거나, 길게 자유롭게 적어도 좋아요."></textarea>
      </div>
      <div class="card">
        <h2>🏷️ 태그</h2>
        <input type="text" id="tagsField" placeholder="#가족, #업무 처럼 쉼표로 구분">
      </div>
      <div class="btn-row end actions-spaced" id="dailyActions">
        <button id="saveDaily" class="btn primary">저장</button>
        <button id="clearDaily" class="btn danger">지우기</button>
        <span id="statusDaily" class="muted">불러옴</span>
      </div>
    </section>

    <section id="page-weekly" class="page">
      <div class="date-row">
        <button id="prevWeek" class="btn">&lt;</button>
        <input type="week" id="weekPicker">
        <button id="nextWeek" class="btn">&gt;</button>
        <button id="thisWeekBtn" class="btn outline">이번 주</button>
        <span id="weekText" class="date-text"></span>
        <span id="weekTextNice" class="date-text nice"></span>
      </div>
      <div class="card">
        <h2>✅ 미션 (체크박스)</h2>
        <div id="missionList"></div>
        <div class="add-mission">
          <input type="text" id="newMission" placeholder="미션 추가">
          <button id="addMission" class="btn">+ 추가</button>
        </div>
      </div>
      <div class="card">
        <h2>🫶 오늘의 문구</h2>
        <textarea id="healingText" class="auto" placeholder="오늘의 문구"></textarea>
        <div class="btn-row actions-spaced">
          <button id="randomHealing" class="btn">랜덤</button>
          <button id="saveWeekly" class="btn primary">저장</button>
          <button id="clearWeekly" class="btn danger">지우기</button>
        </div>
        <button id="startCopy" class="btn link">✍️ 필사 시작</button>
        <textarea id="copyArea" class="auto hidden" placeholder="문구를 따라 적어보세요."></textarea>
      </div>
    </section>

    <section id="page-search" class="page">
      <div class="card">
        <h2>🔎 검색</h2>
        <input type="text" id="searchInput" placeholder="키워드 또는 #태그 (예: 보고서, #업무)">
        <div class="btn-row actions-spaced">
          <button id="searchBtn" class="btn">검색</button>
          <button id="searchClear" class="btn">지우기</button>
        </div>
      </div>
      <div class="card">
        <h3>결과</h3>
        <div id="searchResults"></div>
      </div>
    </section>

    <section id="page-settings" class="page">
      <div class="card">
        <h2>🔐 로그인</h2>
        <div class="btn-row actions-spaced">
          <button id="openLogin" class="btn">로그인</button>
          <button id="btnSignOut" class="btn outline">로그아웃</button>
        </div>
        <p class="muted" id="authState">로그아웃 상태</p>
      </div>

      <div class="card">
        <h2>📦 백업/복원</h2>
        <div class="settings-grid">
          <button id="exportJSON" class="btn">JSON 파일로 저장</button>
          <button id="shareJSON" class="btn">JSON 공유(카톡 등)</button>
          <label class="file-wrap btn">
            <input type="file" id="importFile" accept=".json"/>파일 선택
          </label>
          <button id="importJSON" class="btn">JSON 가져오기</button>
          <button id="refreshCache" class="btn outline">캐시 새로고침(업데이트)</button>
          <button id="resetLocal" class="btn danger">로컬 데이터 초기화</button>
        </div>
        <p id="fileName" class="muted"></p>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <small>오프라인 + 클라우드 동기화 · v2.4.0</small>
  </footer>

  <div id="loginModal" class="modal">
    <div class="modal-panel">
      <h3>로그인</h3>
      <label class="lbl">이메일</label>
      <input type="email" id="loginEmail" placeholder="you@example.com">
      <label class="lbl">비밀번호</label>
      <input type="password" id="loginPwd" placeholder="••••••••">
      <div class="btn-row actions-spaced modal-actions">
        <button id="modalSignIn" class="btn primary">로그인</button>
        <button id="modalSignUp" class="btn">회원가입</button>
        <button id="modalClose" class="btn">닫기</button>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>
  </div>

  <!-- Firebase compat (필요 시 로드됨) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  
// v2.4.0 single-file build – robust init
(function(){
  // --- Firebase (optional; app은 로그인 비활성 상태에서도 동작) ---
  var firebaseReady = false, auth=null, db=null;
  try{
    var firebaseConfig = {
      apiKey: "AIzaSyAOqrdA0aHL5lMXOOmdtj8mnLi6zgSXoiM",
      authDomain: "thanksdiary-dca35.firebaseapp.com",
      projectId: "thanksdiary-dca35",
      storageBucket: "thanksdiary-dca35.appspot.com",
      messagingSenderId: "250477396044",
      appId: "1:250477396044:web:aa1cf155f01263e08834e9"
    };
    if(window.firebase && firebase.initializeApp){
      if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      auth = firebase.auth(); db = firebase.firestore();
      firebaseReady = true;
    }
  }catch(e){ console.log('Firebase init skipped', e); }

  // --- utils ---
  function $(s){ return document.querySelector(s); }
  function ymd(date){ var d=new Date(date); var tz=d.getTimezoneOffset()*60000; return new Date(d.getTime()-tz).toISOString().slice(0,10); }
  function formatDatePretty(dateStr){ var d=new Date(dateStr); return d.getFullYear()+'. '+(d.getMonth()+1)+'. '+d.getDate()+'.'; }
  function getWeekId(date){
    var d=new Date(date); var t=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    var n=(t.getUTCDay()+6)%7; t.setUTCDate(t.getUTCDate()-n+3);
    var ft=new Date(Date.UTC(t.getUTCFullYear(),0,4));
    var w=1+Math.round(((t-ft)/86400000-3+((ft.getUTCDay()+6)%7))/7); var y=t.getUTCFullYear();
    return y+'-W'+(''+w).padStart(2,'0');
  }
  function weekPretty(weekId){ var sp=weekId.split('-W'); return sp[0]+' '+parseInt(sp[1],10)+'번째 주'; }
  function weekOfMonthStr(date){
    var d=new Date(date); var first=new Date(d.getFullYear(), d.getMonth(), 1);
    var fd=first.getDay(); if(fd===0) fd=7; var w=Math.floor((fd-1 + d.getDate() + 6)/7); if(w<1) w=1;
    return d.getFullYear()+'년 '+(d.getMonth()+1)+'월 '+w+'주';
  }
  function parseTags(s){ if(!s) return []; return s.split(',').map(function(t){t=t.trim(); return t? (t[0]==='#'?t:'#'+t):null}).filter(Boolean); }
  function autoResize(el){ if(!el) return; el.style.height='auto'; el.style.height=(el.scrollHeight+2)+'px'; }
  function bindAuto(el){ if(!el) return; autoResize(el); el.addEventListener('input', function(){ autoResize(el); }); }

  // --- data pools ---
  var questionPool=['오늘 나는 무엇을 잘했나요?','사람들에게 어떤 사람으로 기억되고 싶나요?','오늘 나를 웃게 만든 순간은 무엇이었나요?','요즘 나를 설레게 하는 작은 일은?','지금의 나에게 필요한 한 문장은?','오늘 배운 것 하나는 무엇인가요?','나는 무엇을 포기하지 않았나요?','최근 나를 힘들게 한 일, 거기서 배운 점은?','오늘 나에게 가장 고마운 사람은 누구였나요?','앞으로의 나에게 전하고 싶은 말은?','나의 강점 한 가지를 적어보세요.','오늘 놓치지 않은 작은 친절은?','오늘 내 마음의 날씨는 어땠나요?'];
  var healingPool=['부러움 대신 배움을 고르면 마음은 가벼워진다','완벽보다 꾸준함이 조용히 이긴다','오늘의 나를 어제의 나와만 비교하면 삶이 단단해진다','불안은 계획을 좋아한다 작은 계획 하나면 충분하다','한 번의 깊은 호흡이 마음의 재부팅이다','사랑받는 것보다 믿을 만한 사람이 되는 게 오래간다','상처를 말로 꺼내면 무게가 나눠진다','작은 친절은 돌아오지 않아도 흔적을 남긴다','내 속도가 느려 보여도 멈추지 않으면 결국 닿는다','인정은 포기가 아니다 받아들임은 시작이다','해야 할 일 앞에서 숨고 싶을 땐 아주 작은 시작부터','오늘의 수고를 내일의 나에게 친절로 남긴다'];

  // --- storage ---
  var settingsKey='td-v240-settings', storeKey='td-v240-data';
  function loadSettings(){ try{ return JSON.parse(localStorage.getItem(settingsKey)) || {}; }catch(e){ return {}; } }
  function saveSettings(s){ localStorage.setItem(settingsKey, JSON.stringify(s)); }
  function nextFromPool(key, pool){
    var s=loadSettings(); if(!s._cursor) s._cursor={}; if(!s._order) s._order={};
    if(!s._order[key] || s._order[key].length!==pool.length){
      s._order[key]=[]; for(var i=0;i<pool.length;i++) s._order[key].push(i);
      s._order[key].sort(function(){ return Math.random()-0.5; }); s._cursor[key]=0;
    }
    var idx=s._order[key][s._cursor[key]%pool.length]; s._cursor[key]=(s._cursor[key]+1)%pool.length;
    saveSettings(s); return pool[idx];
  }
  function loadAll(){ try{ return JSON.parse(localStorage.getItem(storeKey)) || {daily:{},weekly:{}}; }catch(e){ return {daily:{},weekly:{}}; }
  function saveAll(d){ localStorage.setItem(storeKey, JSON.stringify(d)); }

  // --- elements ---
  var dailyDate, dailyDateText, questionText, answerText, eventField, thoughtField, feelingField, resultField, grat1, grat2, grat3, dailyNote, tagsField, statusDaily;
  var weekPicker, weekText, weekTextNice;

  function grab(){ // late binding after DOM ready
    dailyDate=$("#dailyDate"); dailyDateText=$("#dailyDateText");
    questionText=$("#questionText"); answerText=$("#answerText");
    eventField=$("#eventField"); thoughtField=$("#thoughtField");
    feelingField=$("#feelingField"); resultField=$("#resultField");
    grat1=$("#grat1"); grat2=$("#grat2"); grat3=$("#grat3");
    dailyNote=$("#dailyNote"); tagsField=$("#tagsField"); statusDaily=$("#statusDaily");
    weekPicker=$("#weekPicker"); weekText=$("#weekText"); weekTextNice=$("#weekTextNice");
    [questionText,answerText,eventField,thoughtField,feelingField,resultField,dailyNote].forEach(bindAuto);
  }

  // --- routing ---
  function show(name){
    var pages=document.querySelectorAll('.page'); for(var i=0;i<pages.length;i++){ pages[i].classList.remove('active'); }
    var p=document.querySelector('#page-'+(name||'daily')); if(p) p.classList.add('active');
    var tabs=document.querySelectorAll('.tab-btn'); for(var j=0;j<tabs.length;j++){ tabs[j].classList.remove('active'); }
    var t=document.querySelector('#tab-'+(name||'daily')); if(t) t.classList.add('active');
  }
  function onHash(){ var h=(location.hash.replace(/^#\\/?/,'')||'daily'); show(h); }

  // --- daily ---
  function setDailyDate(d){ dailyDate.value=ymd(d); dailyDateText.textContent=formatDatePretty(dailyDate.value); loadDaily(); }
  function shiftDaily(n){ var cur=new Date(dailyDate.value||new Date()); cur.setDate(cur.getDate()+n); setDailyDate(cur); }
  function loadDaily(){
    var key=dailyDate.value||ymd(new Date()); var d=null; var user=auth && auth.currentUser;
    function fill(d){
      d=d||{}; if(!d.question) d.question=nextFromPool('q',questionPool);
      questionText.value=d.question||''; answerText.value=d.answer||'';
      eventField.value=d.event||''; thoughtField.value=d.thought||''; feelingField.value=d.feeling||''; resultField.value=d.result||'';
      grat1.value=(d.gratitude&&d.gratitude[0])||''; grat2.value=(d.gratitude&&d.gratitude[1])||''; grat3.value=(d.gratitude&&d.gratitude[2])||'';
      dailyNote.value=d.note||''; tagsField.value=(d.tags||[]).join(', '); statusDaily.textContent='불러옴';
      [questionText,answerText,eventField,thoughtField,feelingField,resultField,dailyNote].forEach(autoResize);
    }
    if(user && db){
      db.collection('users').doc(user.uid).collection('daily').doc(key).get().then(function(s){ d=s.exists?s.data():null; if(!d){var loc=loadAll(); d=loc.daily[key]||null;} fill(d); })
      .catch(function(){ var loc=loadAll(); d=loc.daily[key]||null; fill(d); });
    }else{ var loc=loadAll(); d=loc.daily[key]||null; fill(d); }
  }
  function saveDailyNow(){
    var all=loadAll(); var key=dailyDate.value||ymd(new Date());
    all.daily[key]={ question:questionText.value, answer:answerText.value.trim(), event:eventField.value.trim(),
      thought:thoughtField.value.trim(), feeling:feelingField.value.trim(), result:resultField.value.trim(),
      gratitude:[grat1.value.trim(),grat2.value.trim(),grat3.value.trim()], note:dailyNote.value.trim(),
      tags:parseTags(tagsField.value), updatedAt:new Date().toISOString() };
    saveAll(all);
    var user=auth && auth.currentUser;
    if(user && db){ db.collection('users').doc(user.uid).collection('daily').doc(key).set(all.daily[key],{merge:true})
      .then(function(){ statusDaily.textContent='저장됨(클라우드)'; alert('저장 완료! (클라우드)'); })
      .catch(function(e){ statusDaily.textContent='오류'; alert('저장 실패: '+e); }); }
    else{ statusDaily.textContent='저장됨(로컬)'; alert('저장 완료!'); }
  }
  function clearDailyNow(){ if(!confirm('이 날짜의 데이터를 모두 지울까요?')) return;
    var all=loadAll(); var key=dailyDate.value||ymd(new Date()); delete all.daily[key]; saveAll(all);
    var user=auth&&auth.currentUser; if(user&&db){ db.collection('users').doc(user.uid).collection('daily').doc(key).delete().catch(function(){}); }
    loadDaily(); statusDaily.textContent='삭제됨'; }

  // --- weekly ---
  function setWeekByDate(dt){
    var id=getWeekId(dt); if(weekPicker) weekPicker.value=id;
    if(weekText) weekText.textContent=weekPretty(id);
    if(weekTextNice) weekTextNice.textContent=weekOfMonthStr(dt);
    loadWeekly();
  }
  function shiftWeek(n){
    var val=weekPicker && weekPicker.value ? weekPicker.value : getWeekId(new Date());
    var sp=val.split('-W'); var y=parseInt(sp[0],10); var w=parseInt(sp[1],10);
    var base=new Date(Date.UTC(y,0,1+(w-1)*7)); base.setUTCDate(base.getUTCDate()+n*7);
    setWeekByDate(new Date(base));
  }
  function renderMissions(items){
    var missionList=$("#missionList"); missionList.innerHTML='';
    items=(items||[]); items.forEach(function(m,idx){
      var row=document.createElement('div'); row.className='mission-item';
      var cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!m.done; cb.addEventListener('change', function(){ m.done=cb.checked; saveWeeklyData(); });
      var txt=document.createElement('input'); txt.type='text'; txt.value=m.text||''; txt.placeholder='미션 내용'; txt.addEventListener('input', function(){ m.text=txt.value; });
      var del=document.createElement('button'); del.className='btn danger'; del.textContent='삭제';
      del.addEventListener('click', function(){ if(!confirm('삭제할까요?'))return; items.splice(idx,1); renderMissions(items); saveWeeklyData(); });
      row.appendChild(cb); row.appendChild(txt); row.appendChild(del); missionList.appendChild(row);
    });
  }
  function currentWeekKey(){ return weekPicker && weekPicker.value ? weekPicker.value : getWeekId(new Date()); }
  function loadWeekly(){
    var key=currentWeekKey(); var w=null; var user=auth && auth.currentUser;
    function fill(w){ w=w||{missions:[],healing:''}; renderMissions(w.missions||[]); var ht=$("#healingText"); if(ht){ ht.value=w.healing||''; bindAuto(ht); } }
    if(user && db){ db.collection('users').doc(user.uid).collection('weekly').doc(key).get().then(function(s){ w=s.exists?s.data():null; if(!w){ var data=loadAll(); w=data.weekly[key]||null; } fill(w); })
      .catch(function(){ var data=loadAll(); w=data.weekly[key]||null; fill(w); });
    }else{ var data=loadAll(); w=data.weekly[key]||null; fill(w); }
  }
  function collectMissions(){ var rows=document.querySelectorAll('#missionList .mission-item'); var out=[];
    rows.forEach(function(r){ var cb=r.querySelector('input[type="checkbox"]'); var txt=r.querySelector('input[type="text"]'); var t=(txt&&txt.value||'').trim(); if(t) out.push({text:t,done:cb&&cb.checked}); });
    return out;
  }
  function saveWeeklyData(){
    var key=currentWeekKey(); var all=loadAll(); var ht=$("#healingText"); var heal=ht?ht.value.trim():'';
    all.weekly[key]={ missions:collectMissions(), healing:heal, updatedAt:new Date().toISOString() }; saveAll(all);
    var user=auth && auth.currentUser; if(user&&db){ db.collection('users').doc(user.uid).collection('weekly').doc(key).set(all.weekly[key],{merge:true}); }
  }

  // --- search & backup ---
  function doSearch(){
    var q=$("#searchInput").value.trim().toLowerCase(); var res=$("#searchResults"); res.innerHTML='';
    if(!q){ res.textContent='검색어를 입력하세요.'; return; }
    var all=loadAll(); var out=[];
    function pushIf(k,d){ var text=[d.question,d.answer,d.event,d.thought,d.feeling,d.result,d.note,(d.tags||[]).join(' ')].join(' ').toLowerCase(); if(text.indexOf(q)>=0) out.push({when:k,data:d}); }
    Object.keys(all.daily).forEach(function(k){ pushIf(k,all.daily[k]); });
    res.innerHTML = out.length ? out.map(function(x){ return '<div class="search-item"><b>'+x.when+'</b> — '+(x.data.note||x.data.answer||'')+'</div>'; }).join('') : '결과 없음';
  }
  function exportJSON(){ var data=loadAll(); var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='thanks-diary-backup.json'; a.click(); }
  function importJSON(){ var f=$("#importFile"); if(!f || !f.files || !f.files[0]){ alert('가져올 JSON 파일을 선택해 주세요.'); return; }
    var reader=new FileReader(); reader.onload=function(){ try{ var obj=JSON.parse(reader.result); if(!obj || !obj.daily || !obj.weekly) throw '형식 오류'; saveAll(obj); alert('가져오기 완료'); }catch(e){ alert('가져오기 실패: '+e); } }; reader.readAsText(f.files[0]); }
  async function shareJSON(){ try{ var data=loadAll(); var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); var file=new File([blob],'thanks-diary-backup.json',{type:'application/json'});
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({files:[file], title:'지니짱 감사일기 백업', text:'백업 파일입니다.'}); }
    else{ exportJSON(); alert('공유 API를 지원하지 않아 파일 다운로드로 대체합니다.'); }
  }catch(e){ alert('공유 실패/취소: '+e); } }

  // --- auth modal ---
  var lm, loginEmail, loginPwd, loginMsg;
  function openModal(){ if(lm){ lm.classList.add('open'); loginMsg.textContent=''; } }
  function closeModal(){ if(lm){ lm.classList.remove('open'); } }
  function signIn(){ if(!firebaseReady){ alert('Firebase가 로드되지 않았습니다. 잠시 후 다시 시도하세요.'); return; }
    var email=(loginEmail&&loginEmail.value)||'', pwd=(loginPwd&&loginPwd.value)||'';
    auth.signInWithEmailAndPassword(email.trim(), pwd).then(function(){ closeModal(); })
      .catch(function(e){ var m='로그인 실패: '+(e && e.message ? e.message : e); loginMsg.textContent=m; alert(m); });
  }
  function signUp(){ if(!firebaseReady){ alert('Firebase가 로드되지 않았습니다.'); return; }
    var email=(loginEmail&&loginEmail.value)||'', pwd=(loginPwd&&loginPwd.value)||'';
    auth.createUserWithEmailAndPassword(email.trim(), pwd).then(function(){ closeModal(); })
      .catch(function(e){ var m='회원가입 실패: '+(e && e.message ? e.message : e); loginMsg.textContent=m; alert(m); });
  }
  window.TD_openLogin=openModal; window.TD_closeLogin=closeModal; window.TD_signIn=signIn; window.TD_signUp=signUp;

  // --- wire clicks (defensive) ---
  document.addEventListener('click', function(e){
    var id=e && e.target && e.target.id;
    if(id==='tab-daily'||id==='tab-weekly'||id==='tab-search'||id==='tab-settings'){ /* hash anchors handle */ }
    if(id==='prevDay') shiftDaily(-1);
    if(id==='nextDay') shiftDaily(1);
    if(id==='todayBtn') setDailyDate(new Date());
    if(id==='btnAnotherQ'){ questionText.value=nextFromPool('q',questionPool); autoResize(questionText); }
    if(id==='saveDaily') saveDailyNow();
    if(id==='clearDaily') clearDailyNow();
    if(id==='prevWeek') shiftWeek(-1);
    if(id==='nextWeek') shiftWeek(1);
    if(id==='thisWeekBtn') setWeekByDate(new Date());
    if(id==='addMission'){ var nt=$("#newMission").value.trim(); if(!nt) return; var all=loadAll(); var k=currentWeekKey(); var w=all.weekly[k]||{missions:[],healing:''}; w.missions.push({text:nt,done:false}); all.weekly[k]=w; saveAll(all); $("#newMission").value=''; renderMissions(w.missions); saveWeeklyData(); }
    if(id==='saveWeekly'){ saveWeeklyData(); alert('주간 데이터 저장 완료'); }
    if(id==='clearWeekly'){ if(!confirm('이 주차의 주간 데이터를 모두 지울까요?')) return; var all=loadAll(); var k=currentWeekKey(); delete all.weekly[k]; saveAll(all); var u=auth&&auth.currentUser; if(u&&db){ db.collection('users').doc(u.uid).collection('weekly').doc(k).delete().catch(function(){});} loadWeekly(); }
    if(id==='randomHealing'){ var ht=$("#healingText"); if(ht){ ht.value=nextFromPool('h',healingPool); autoResize(ht); } }
    if(id==='startCopy'){ var c=$("#copyArea"); if(!c) return; c.classList.toggle('hidden'); if(!c.classList.contains('hidden')){ c.value=$("#healingText").value; autoResize(c); } }
    if(id==='searchBtn') doSearch();
    if(id==='searchClear'){ var si=$("#searchInput"); if(si) si.value=''; var sr=$("#searchResults"); if(sr) sr.innerHTML=''; }
    if(id==='exportJSON') exportJSON();
    if(id==='shareJSON') shareJSON();
    if(id==='importJSON') importJSON();
    if(id==='refreshCache'){ alert('서비스워커 없이 동작합니다. 새로고침하면 최신 적용됩니다.'); }
    if(id==='resetLocal'){ if(!confirm('로컬 데이터를 모두 삭제할까요?')) return; localStorage.removeItem(storeKey); alert('로컬 데이터 삭제 완료'); }
    if(id==='authMiniLogout' || id==='btnSignOut'){ if(auth) auth.signOut(); }
    if(id==='openLogin' || id==='authMiniLogin') openModal();
    if(id==='modalClose') closeModal();
    if(id==='modalSignIn') signIn();
    if(id==='modalSignUp') signUp();
  });

  // --- init ---
  function init(){
    grab();
    if(!location.hash) location.hash='#/daily';
    onHash(); window.addEventListener('hashchange', onHash);
    var d=new Date();
    if(dailyDate){ dailyDate.value=ymd(d); dailyDateText.textContent=formatDatePretty(dailyDate.value); }
    setWeekByDate(d); loadDaily();

    if(firebaseReady){
      auth.onAuthStateChanged(function(user){
        var miniState=$("#authMiniState"), miniLogin=$("#authMiniLogin"), miniLogout=$("#authMiniLogout");
        if(miniState) miniState.textContent = user? '로그인됨':'로그아웃 상태';
        if(miniLogin) miniLogin.classList.toggle('hidden', !!user);
        if(miniLogout) miniLogout.classList.toggle('hidden', !user);
        var node=$("#authState"); if(node) node.textContent = user ? ('로그인됨: '+(user.email||user.uid)) : '로그아웃 상태';
      });
    }

    // 캐시/서비스워커 제거(남아있다면)
    if('serviceWorker' in navigator){
      navigator.serviceWorker.getRegistrations().then(function(rs){ rs.forEach(function(r){ r.unregister(); }); });
      if(window.caches && caches.keys) caches.keys().then(function(keys){ keys.forEach(function(k){ caches.delete(k); }); });
    }
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
})();

  </script>
</body>
</html>
