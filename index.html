<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#fff6c9">
  <title>ì§€ë‹ˆì§± ê°ì‚¬ì¼ê¸°</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jua&family=Gowun+Dodum&display=swap" rel="stylesheet">
  <style>
  
:root{
  --bg:#fffaf0; --header1:#ffefad; --header2:#fff6c9; --card:#ffffff;
  --ink:#3a2e39; --muted:#8b7f86; --brand:#f5d76e; --danger:#ff88a3; --line:#f1e7d7;
}
*{box-sizing:border-box}
html{ -webkit-text-size-adjust:100%; }
body{ margin:0;padding:0; background:linear-gradient(180deg,#fff7ee,var(--bg) 35%); color:var(--ink);
  font-family:'Gowun Dodum', system-ui, -apple-system, 'Noto Sans KR', sans-serif; }
h1,h2,h3{ font-family:'Jua','Gowun Dodum',sans-serif; letter-spacing:.2px; margin:.2rem 0 .6rem }
.hidden{display:none}
.app-header{ position:sticky; top:0; z-index:10; background:linear-gradient(90deg,var(--header1),var(--header2) 60%);
  border-bottom:1px solid rgba(0,0,0,.05); padding:.8rem .9rem; }
.title-area{max-width:900px;margin:0 auto; display:flex; align-items:flex-end; justify-content:space-between; gap:.75rem; flex-wrap:wrap;}
.logo{display:flex; align-items:center; gap:.55rem; font-size: clamp(1.15rem, 4.2vw, 1.6rem); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.logo:before{ content:'âœ¶'; font-size:1.1rem; color:#f5c518; filter:drop-shadow(0 1px 0 rgba(0,0,0,.12)); }
.header-right{display:flex; flex-direction:column; gap:.55rem; align-items:flex-end}
.header-auth{ display:flex; align-items:center; gap:.55rem; }
.mini-btn{ padding:.35rem .6rem; border:1px solid var(--line); border-radius:.65rem; background:#fff; font-weight:700; }
.tabs{display:flex; gap:.75rem; flex-wrap:wrap}
.tab-btn{ flex:1 1 120px; text-align:center; text-decoration:none; color:inherit; padding:.65rem .9rem; border:1px solid var(--line); background:#fff; border-radius:.9rem; font-weight:700;}
.tab-btn.active{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(245,215,110,.24); }
main{padding:1rem;max-width:900px;margin:0 auto}
.page{ display:none } .page.active, .page.default{ display:block }
.date-row{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom:.6rem}
.date-text{margin-left:auto; font-weight:700; color:#2563eb}
.date-text.nice{ color:#7c3aed; }
.card{ background:var(--card); border:1px solid var(--line); border-radius:1rem; padding:1rem; margin:1rem 0; box-shadow:0 6px 18px rgba(0,0,0,.06) }
.lbl{display:block; font-weight:700; margin:.5rem 0 .25rem}
textarea, input[type="text"], input[type="email"], input[type="password"], input[type="date"], input[type="week"]{ width:100%; padding:.85rem; border:1px solid var(--line);
  border-radius:.75rem; font-size:1.02rem; background:#fff; font-family:'Gowun Dodum','Jua',sans-serif; }
::placeholder{opacity:.6; font-family:'Gowun Dodum','Jua',sans-serif}
textarea{min-height:96px; resize:vertical}
.qbox textarea[readonly]{background:#fffdf5}
.gratitude-list{margin:.25rem 0 .5rem 1rem}
.btn-row{display:flex; gap:1rem; flex-wrap:wrap}
.actions-spaced{gap:1rem; row-gap:1rem}
.btn{ padding:.65rem .95rem; border:1px solid var(--line); border-radius:.9rem; background:#fff; font-weight:700; cursor:pointer; }
.btn.primary{background:var(--brand); color:#000; border-color:var(--brand)}
.btn.danger{background:var(--danger); color:#fff; border-color:var(--danger)}
.btn.outline{background:#fff}
.btn.link{background:transparent; border:none; padding:.2rem 0; text-decoration:underline; cursor:pointer}
.add-mission{display:flex; gap:.5rem; margin-top:.5rem}
.mission-item{display:flex; gap:.5rem; align-items:center; border:1px solid var(--line); padding:.5rem; border-radius:.75rem; margin:.25rem 0; background:#fff}
.mission-item input[type="text"]{flex:1; border:none; padding:.5rem; background:transparent}
.mission-item input[type="checkbox"]{transform:scale(1.2)}
.app-footer{padding:1.2rem; text-align:center; color:var(--muted)}
.row{display:flex; gap:.5rem; align-items:center; margin:.5rem 0}
.muted{color:var(--muted)}
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50; padding:1rem; }
.modal.open{ display:flex; }
.modal-panel{ width:min(520px, 95vw); background:#fff; border-radius:1rem; padding:1rem; box-shadow:0 10px 30px rgba(0,0,0,.25); }
.modal-panel h3{ margin:.25rem 0 1rem; font-size:1.25rem; }
.modal-actions{ gap:12px; }
@media (max-width: 380px){
  .modal-actions{ flex-direction:column; }
  .modal-actions .btn{ width:100%; }
}
#loginMsg{ margin-top:.5rem; color:#d02; font-weight:700; }
.settings-grid{ display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:.8rem; }
.file-wrap{ position:relative; overflow:hidden; display:inline-block; text-align:center; }
.file-wrap input[type="file"]{ position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer; }
#fileName{ margin-top:.3rem; }

  </style>
</head>
<body>
  <header class="app-header">
    <div class="title-area">
      <h1 class="logo">ì§€ë‹ˆì§± ê°ì‚¬ì¼ê¸°</h1>
      <div class="header-right">
        <div class="header-auth">
          <span id="authMiniState" class="muted">ë¡œê·¸ì•„ì›ƒ ìƒíƒœ</span>
          <button id="authMiniLogin" class="mini-btn">ë¡œê·¸ì¸</button>
          <button id="authMiniLogout" class="mini-btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <nav class="tabs">
          <a href="#/daily" class="tab-btn" id="tab-daily">ë°ì¼ë¦¬</a>
          <a href="#/weekly" class="tab-btn" id="tab-weekly">ìœ„í´ë¦¬</a>
          <a href="#/search" class="tab-btn" id="tab-search">ê²€ìƒ‰</a>
          <a href="#/settings" class="tab-btn" id="tab-settings">ì„¤ì •/ë°±ì—…</a>
        </nav>
      </div>
    </div>
  </header>

  <main id="app-main">
    <section id="page-daily" class="page default">
      <div class="date-row">
        <button id="prevDay" class="btn">&lt;</button>
        <input type="date" id="dailyDate">
        <button id="nextDay" class="btn">&gt;</button>
        <button id="todayBtn" class="btn outline">ì˜¤ëŠ˜</button>
        <span id="dailyDateText" class="date-text"></span>
      </div>
      <div class="card">
        <h2>ğŸª ì˜¤ëŠ˜ì˜ ì§ˆë¬¸</h2>
        <div class="qbox">
          <textarea id="questionText" class="auto" readonly placeholder="ì§ˆë¬¸ì´ ì¤€ë¹„ë˜ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦"></textarea>
          <div class="q-actions actions-spaced">
            <button id="btnAnotherQ" class="btn">ë‹¤ë¥¸ ì§ˆë¬¸</button>
          </div>
        </div>
        <label class="lbl">ë‹µë³€</label>
        <textarea id="answerText" class="auto" placeholder="ì§ˆë¬¸ì— ëŒ€í•œ ë‚˜ì˜ ë‹µì„ ì ì–´ë³´ì„¸ìš”."></textarea>
      </div>
      <div class="card">
        <h2>ğŸ§  ê°ì •ì¼ê¸°</h2>
        <p class="muted">ì‚¬ê±´ì„ ì‚¬ì‹¤ëŒ€ë¡œ ì ê³ , ê·¸ë•Œì˜ ìƒê°ê³¼ ê°ì •ì„ êµ¬ë¶„í•´ ë³¸ ë’¤ ê²°ê³¼ë¥¼ ê°„ë‹¨íˆ ë‚¨ê²¨ë³´ì„¸ìš”.</p>
        <label class="lbl">ì‚¬ê±´</label>
        <textarea id="eventField" class="auto" placeholder="ì˜¤ëŠ˜ ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆë‚˜ìš”?"></textarea>
        <label class="lbl">ìƒê°</label>
        <textarea id="thoughtField" class="auto" placeholder="ê·¸ë•Œ ì–´ë–¤ ìƒê°ì´ ë“¤ì—ˆë‚˜ìš”?"></textarea>
        <label class="lbl">ê°ì •</label>
        <textarea id="feelingField" class="auto" placeholder="ê°ì •ì˜ ê°•ë„/ì´ìœ ë¥¼ í•¨ê»˜ ì ì–´ë³´ì„¸ìš”."></textarea>
        <label class="lbl">ê²°ê³¼</label>
        <textarea id="resultField" class="auto" placeholder="ê·¸ ê²°ê³¼ ë‚˜ëŠ” ì–´ë–»ê²Œ í–‰ë™í–ˆë‚˜ìš”?"></textarea>
      </div>
      <div class="card">
        <h2>ğŸŒ¼ ê°ì‚¬ì¼ê¸°</h2>
        <ol class="gratitude-list">
          <li><input type="text" id="grat1" placeholder="ì‘ì€ ê²ƒë„ ì¢‹ì•„ìš”."></li>
          <li><input type="text" id="grat2" placeholder="ì‚¬ëŒ/í–‰ë™/í–‰ìš´ ë“± ë¬´ì—‡ì´ë“ ."></li>
          <li><input type="text" id="grat3" placeholder="ì˜¤ëŠ˜ì„ ì¢‹ê²Œ ë§Œë“  ê²ƒ."></li>
        </ol>
      </div>
      <div class="card">
        <h2>ğŸ“” ì¼ìƒì¼ê¸°</h2>
        <textarea id="dailyNote" class="auto" placeholder="ì§§ê²Œ ìš”ì•½í•˜ê±°ë‚˜, ê¸¸ê²Œ ììœ ë¡­ê²Œ ì ì–´ë„ ì¢‹ì•„ìš”."></textarea>
      </div>
      <div class="card">
        <h2>ğŸ·ï¸ íƒœê·¸</h2>
        <input type="text" id="tagsField" placeholder="#ê°€ì¡±, #ì—…ë¬´ ì²˜ëŸ¼ ì‰¼í‘œë¡œ êµ¬ë¶„">
      </div>
      <div class="btn-row end actions-spaced" id="dailyActions">
        <button id="saveDaily" class="btn primary">ì €ì¥</button>
        <button id="clearDaily" class="btn danger">ì§€ìš°ê¸°</button>
        <span id="statusDaily" class="muted">ë¶ˆëŸ¬ì˜´</span>
      </div>
    </section>

    <section id="page-weekly" class="page">
      <div class="date-row">
        <button id="prevWeek" class="btn">&lt;</button>
        <input type="week" id="weekPicker">
        <button id="nextWeek" class="btn">&gt;</button>
        <button id="thisWeekBtn" class="btn outline">ì´ë²ˆ ì£¼</button>
        <span id="weekText" class="date-text"></span>
        <span id="weekTextNice" class="date-text nice"></span>
      </div>
      <div class="card">
        <h2>âœ… ë¯¸ì…˜ (ì²´í¬ë°•ìŠ¤)</h2>
        <div id="missionList"></div>
        <div class="add-mission">
          <input type="text" id="newMission" placeholder="ë¯¸ì…˜ ì¶”ê°€">
          <button id="addMission" class="btn">+ ì¶”ê°€</button>
        </div>
      </div>
      <div class="card">
        <h2>ğŸ«¶ ì˜¤ëŠ˜ì˜ ë¬¸êµ¬</h2>
        <textarea id="healingText" class="auto" placeholder="ì˜¤ëŠ˜ì˜ ë¬¸êµ¬"></textarea>
        <div class="btn-row actions-spaced">
          <button id="randomHealing" class="btn">ëœë¤</button>
          <button id="saveWeekly" class="btn primary">ì €ì¥</button>
          <button id="clearWeekly" class="btn danger">ì§€ìš°ê¸°</button>
        </div>
        <button id="startCopy" class="btn link">âœï¸ í•„ì‚¬ ì‹œì‘</button>
        <textarea id="copyArea" class="auto hidden" placeholder="ë¬¸êµ¬ë¥¼ ë”°ë¼ ì ì–´ë³´ì„¸ìš”."></textarea>
      </div>
    </section>

    <section id="page-search" class="page">
      <div class="card">
        <h2>ğŸ” ê²€ìƒ‰</h2>
        <input type="text" id="searchInput" placeholder="í‚¤ì›Œë“œ ë˜ëŠ” #íƒœê·¸ (ì˜ˆ: ë³´ê³ ì„œ, #ì—…ë¬´)">
        <div class="btn-row actions-spaced">
          <button id="searchBtn" class="btn">ê²€ìƒ‰</button>
          <button id="searchClear" class="btn">ì§€ìš°ê¸°</button>
        </div>
      </div>
      <div class="card">
        <h3>ê²°ê³¼</h3>
        <div id="searchResults"></div>
      </div>
    </section>

    <section id="page-settings" class="page">
      <div class="card">
        <h2>ğŸ” ë¡œê·¸ì¸</h2>
        <div class="btn-row actions-spaced">
          <button id="openLogin" class="btn">ë¡œê·¸ì¸</button>
          <button id="btnSignOut" class="btn outline">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <p class="muted" id="authState">ë¡œê·¸ì•„ì›ƒ ìƒíƒœ</p>
      </div>

      <div class="card">
        <h2>ğŸ“¦ ë°±ì—…/ë³µì›</h2>
        <div class="settings-grid">
          <button id="exportJSON" class="btn">JSON íŒŒì¼ë¡œ ì €ì¥</button>
          <button id="shareJSON" class="btn">JSON ê³µìœ (ì¹´í†¡ ë“±)</button>
          <label class="file-wrap btn">
            <input type="file" id="importFile" accept=".json"/>íŒŒì¼ ì„ íƒ
          </label>
          <button id="importJSON" class="btn">JSON ê°€ì ¸ì˜¤ê¸°</button>
          <button id="refreshCache" class="btn outline">ìºì‹œ ìƒˆë¡œê³ ì¹¨(ì—…ë°ì´íŠ¸)</button>
          <button id="resetLocal" class="btn danger">ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
        <p id="fileName" class="muted"></p>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <small>ì˜¤í”„ë¼ì¸ + í´ë¼ìš°ë“œ ë™ê¸°í™” Â· v2.4.0</small>
  </footer>

  <div id="loginModal" class="modal">
    <div class="modal-panel">
      <h3>ë¡œê·¸ì¸</h3>
      <label class="lbl">ì´ë©”ì¼</label>
      <input type="email" id="loginEmail" placeholder="you@example.com">
      <label class="lbl">ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="loginPwd" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      <div class="btn-row actions-spaced modal-actions">
        <button id="modalSignIn" class="btn primary">ë¡œê·¸ì¸</button>
        <button id="modalSignUp" class="btn">íšŒì›ê°€ì…</button>
        <button id="modalClose" class="btn">ë‹«ê¸°</button>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>
  </div>

  <!-- Firebase compat (í•„ìš” ì‹œ ë¡œë“œë¨) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  
// v2.4.0 single-file build â€“ robust init
(function(){
  // --- Firebase (optional; appì€ ë¡œê·¸ì¸ ë¹„í™œì„± ìƒíƒœì—ì„œë„ ë™ì‘) ---
  var firebaseReady = false, auth=null, db=null;
  try{
    var firebaseConfig = {
      apiKey: "AIzaSyAOqrdA0aHL5lMXOOmdtj8mnLi6zgSXoiM",
      authDomain: "thanksdiary-dca35.firebaseapp.com",
      projectId: "thanksdiary-dca35",
      storageBucket: "thanksdiary-dca35.appspot.com",
      messagingSenderId: "250477396044",
      appId: "1:250477396044:web:aa1cf155f01263e08834e9"
    };
    if(window.firebase && firebase.initializeApp){
      if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      auth = firebase.auth(); db = firebase.firestore();
      firebaseReady = true;
    }
  }catch(e){ console.log('Firebase init skipped', e); }

  // --- utils ---
  function $(s){ return document.querySelector(s); }
  function ymd(date){ var d=new Date(date); var tz=d.getTimezoneOffset()*60000; return new Date(d.getTime()-tz).toISOString().slice(0,10); }
  function formatDatePretty(dateStr){ var d=new Date(dateStr); return d.getFullYear()+'. '+(d.getMonth()+1)+'. '+d.getDate()+'.'; }
  function getWeekId(date){
    var d=new Date(date); var t=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    var n=(t.getUTCDay()+6)%7; t.setUTCDate(t.getUTCDate()-n+3);
    var ft=new Date(Date.UTC(t.getUTCFullYear(),0,4));
    var w=1+Math.round(((t-ft)/86400000-3+((ft.getUTCDay()+6)%7))/7); var y=t.getUTCFullYear();
    return y+'-W'+(''+w).padStart(2,'0');
  }
  function weekPretty(weekId){ var sp=weekId.split('-W'); return sp[0]+' '+parseInt(sp[1],10)+'ë²ˆì§¸ ì£¼'; }
  function weekOfMonthStr(date){
    var d=new Date(date); var first=new Date(d.getFullYear(), d.getMonth(), 1);
    var fd=first.getDay(); if(fd===0) fd=7; var w=Math.floor((fd-1 + d.getDate() + 6)/7); if(w<1) w=1;
    return d.getFullYear()+'ë…„ '+(d.getMonth()+1)+'ì›” '+w+'ì£¼';
  }
  function parseTags(s){ if(!s) return []; return s.split(',').map(function(t){t=t.trim(); return t? (t[0]==='#'?t:'#'+t):null}).filter(Boolean); }
  function autoResize(el){ if(!el) return; el.style.height='auto'; el.style.height=(el.scrollHeight+2)+'px'; }
  function bindAuto(el){ if(!el) return; autoResize(el); el.addEventListener('input', function(){ autoResize(el); }); }

  // --- data pools ---
  var questionPool=['ì˜¤ëŠ˜ ë‚˜ëŠ” ë¬´ì—‡ì„ ì˜í–ˆë‚˜ìš”?','ì‚¬ëŒë“¤ì—ê²Œ ì–´ë–¤ ì‚¬ëŒìœ¼ë¡œ ê¸°ì–µë˜ê³  ì‹¶ë‚˜ìš”?','ì˜¤ëŠ˜ ë‚˜ë¥¼ ì›ƒê²Œ ë§Œë“  ìˆœê°„ì€ ë¬´ì—‡ì´ì—ˆë‚˜ìš”?','ìš”ì¦˜ ë‚˜ë¥¼ ì„¤ë ˆê²Œ í•˜ëŠ” ì‘ì€ ì¼ì€?','ì§€ê¸ˆì˜ ë‚˜ì—ê²Œ í•„ìš”í•œ í•œ ë¬¸ì¥ì€?','ì˜¤ëŠ˜ ë°°ìš´ ê²ƒ í•˜ë‚˜ëŠ” ë¬´ì—‡ì¸ê°€ìš”?','ë‚˜ëŠ” ë¬´ì—‡ì„ í¬ê¸°í•˜ì§€ ì•Šì•˜ë‚˜ìš”?','ìµœê·¼ ë‚˜ë¥¼ í˜ë“¤ê²Œ í•œ ì¼, ê±°ê¸°ì„œ ë°°ìš´ ì ì€?','ì˜¤ëŠ˜ ë‚˜ì—ê²Œ ê°€ì¥ ê³ ë§ˆìš´ ì‚¬ëŒì€ ëˆ„êµ¬ì˜€ë‚˜ìš”?','ì•ìœ¼ë¡œì˜ ë‚˜ì—ê²Œ ì „í•˜ê³  ì‹¶ì€ ë§ì€?','ë‚˜ì˜ ê°•ì  í•œ ê°€ì§€ë¥¼ ì ì–´ë³´ì„¸ìš”.','ì˜¤ëŠ˜ ë†“ì¹˜ì§€ ì•Šì€ ì‘ì€ ì¹œì ˆì€?','ì˜¤ëŠ˜ ë‚´ ë§ˆìŒì˜ ë‚ ì”¨ëŠ” ì–´ë• ë‚˜ìš”?'];
  var healingPool=['ë¶€ëŸ¬ì›€ ëŒ€ì‹  ë°°ì›€ì„ ê³ ë¥´ë©´ ë§ˆìŒì€ ê°€ë²¼ì›Œì§„ë‹¤','ì™„ë²½ë³´ë‹¤ ê¾¸ì¤€í•¨ì´ ì¡°ìš©íˆ ì´ê¸´ë‹¤','ì˜¤ëŠ˜ì˜ ë‚˜ë¥¼ ì–´ì œì˜ ë‚˜ì™€ë§Œ ë¹„êµí•˜ë©´ ì‚¶ì´ ë‹¨ë‹¨í•´ì§„ë‹¤','ë¶ˆì•ˆì€ ê³„íšì„ ì¢‹ì•„í•œë‹¤ ì‘ì€ ê³„íš í•˜ë‚˜ë©´ ì¶©ë¶„í•˜ë‹¤','í•œ ë²ˆì˜ ê¹Šì€ í˜¸í¡ì´ ë§ˆìŒì˜ ì¬ë¶€íŒ…ì´ë‹¤','ì‚¬ë‘ë°›ëŠ” ê²ƒë³´ë‹¤ ë¯¿ì„ ë§Œí•œ ì‚¬ëŒì´ ë˜ëŠ” ê²Œ ì˜¤ë˜ê°„ë‹¤','ìƒì²˜ë¥¼ ë§ë¡œ êº¼ë‚´ë©´ ë¬´ê²Œê°€ ë‚˜ëˆ ì§„ë‹¤','ì‘ì€ ì¹œì ˆì€ ëŒì•„ì˜¤ì§€ ì•Šì•„ë„ í”ì ì„ ë‚¨ê¸´ë‹¤','ë‚´ ì†ë„ê°€ ëŠë ¤ ë³´ì—¬ë„ ë©ˆì¶”ì§€ ì•Šìœ¼ë©´ ê²°êµ­ ë‹¿ëŠ”ë‹¤','ì¸ì •ì€ í¬ê¸°ê°€ ì•„ë‹ˆë‹¤ ë°›ì•„ë“¤ì„ì€ ì‹œì‘ì´ë‹¤','í•´ì•¼ í•  ì¼ ì•ì—ì„œ ìˆ¨ê³  ì‹¶ì„ ë• ì•„ì£¼ ì‘ì€ ì‹œì‘ë¶€í„°','ì˜¤ëŠ˜ì˜ ìˆ˜ê³ ë¥¼ ë‚´ì¼ì˜ ë‚˜ì—ê²Œ ì¹œì ˆë¡œ ë‚¨ê¸´ë‹¤'];

  // --- storage ---
  var settingsKey='td-v240-settings', storeKey='td-v240-data';
  function loadSettings(){ try{ return JSON.parse(localStorage.getItem(settingsKey)) || {}; }catch(e){ return {}; } }
  function saveSettings(s){ localStorage.setItem(settingsKey, JSON.stringify(s)); }
  function nextFromPool(key, pool){
    var s=loadSettings(); if(!s._cursor) s._cursor={}; if(!s._order) s._order={};
    if(!s._order[key] || s._order[key].length!==pool.length){
      s._order[key]=[]; for(var i=0;i<pool.length;i++) s._order[key].push(i);
      s._order[key].sort(function(){ return Math.random()-0.5; }); s._cursor[key]=0;
    }
    var idx=s._order[key][s._cursor[key]%pool.length]; s._cursor[key]=(s._cursor[key]+1)%pool.length;
    saveSettings(s); return pool[idx];
  }
  function loadAll(){ try{ return JSON.parse(localStorage.getItem(storeKey)) || {daily:{},weekly:{}}; }catch(e){ return {daily:{},weekly:{}}; }
  function saveAll(d){ localStorage.setItem(storeKey, JSON.stringify(d)); }

  // --- elements ---
  var dailyDate, dailyDateText, questionText, answerText, eventField, thoughtField, feelingField, resultField, grat1, grat2, grat3, dailyNote, tagsField, statusDaily;
  var weekPicker, weekText, weekTextNice;

  function grab(){ // late binding after DOM ready
    dailyDate=$("#dailyDate"); dailyDateText=$("#dailyDateText");
    questionText=$("#questionText"); answerText=$("#answerText");
    eventField=$("#eventField"); thoughtField=$("#thoughtField");
    feelingField=$("#feelingField"); resultField=$("#resultField");
    grat1=$("#grat1"); grat2=$("#grat2"); grat3=$("#grat3");
    dailyNote=$("#dailyNote"); tagsField=$("#tagsField"); statusDaily=$("#statusDaily");
    weekPicker=$("#weekPicker"); weekText=$("#weekText"); weekTextNice=$("#weekTextNice");
    [questionText,answerText,eventField,thoughtField,feelingField,resultField,dailyNote].forEach(bindAuto);
  }

  // --- routing ---
  function show(name){
    var pages=document.querySelectorAll('.page'); for(var i=0;i<pages.length;i++){ pages[i].classList.remove('active'); }
    var p=document.querySelector('#page-'+(name||'daily')); if(p) p.classList.add('active');
    var tabs=document.querySelectorAll('.tab-btn'); for(var j=0;j<tabs.length;j++){ tabs[j].classList.remove('active'); }
    var t=document.querySelector('#tab-'+(name||'daily')); if(t) t.classList.add('active');
  }
  function onHash(){ var h=(location.hash.replace(/^#\\/?/,'')||'daily'); show(h); }

  // --- daily ---
  function setDailyDate(d){ dailyDate.value=ymd(d); dailyDateText.textContent=formatDatePretty(dailyDate.value); loadDaily(); }
  function shiftDaily(n){ var cur=new Date(dailyDate.value||new Date()); cur.setDate(cur.getDate()+n); setDailyDate(cur); }
  function loadDaily(){
    var key=dailyDate.value||ymd(new Date()); var d=null; var user=auth && auth.currentUser;
    function fill(d){
      d=d||{}; if(!d.question) d.question=nextFromPool('q',questionPool);
      questionText.value=d.question||''; answerText.value=d.answer||'';
      eventField.value=d.event||''; thoughtField.value=d.thought||''; feelingField.value=d.feeling||''; resultField.value=d.result||'';
      grat1.value=(d.gratitude&&d.gratitude[0])||''; grat2.value=(d.gratitude&&d.gratitude[1])||''; grat3.value=(d.gratitude&&d.gratitude[2])||'';
      dailyNote.value=d.note||''; tagsField.value=(d.tags||[]).join(', '); statusDaily.textContent='ë¶ˆëŸ¬ì˜´';
      [questionText,answerText,eventField,thoughtField,feelingField,resultField,dailyNote].forEach(autoResize);
    }
    if(user && db){
      db.collection('users').doc(user.uid).collection('daily').doc(key).get().then(function(s){ d=s.exists?s.data():null; if(!d){var loc=loadAll(); d=loc.daily[key]||null;} fill(d); })
      .catch(function(){ var loc=loadAll(); d=loc.daily[key]||null; fill(d); });
    }else{ var loc=loadAll(); d=loc.daily[key]||null; fill(d); }
  }
  function saveDailyNow(){
    var all=loadAll(); var key=dailyDate.value||ymd(new Date());
    all.daily[key]={ question:questionText.value, answer:answerText.value.trim(), event:eventField.value.trim(),
      thought:thoughtField.value.trim(), feeling:feelingField.value.trim(), result:resultField.value.trim(),
      gratitude:[grat1.value.trim(),grat2.value.trim(),grat3.value.trim()], note:dailyNote.value.trim(),
      tags:parseTags(tagsField.value), updatedAt:new Date().toISOString() };
    saveAll(all);
    var user=auth && auth.currentUser;
    if(user && db){ db.collection('users').doc(user.uid).collection('daily').doc(key).set(all.daily[key],{merge:true})
      .then(function(){ statusDaily.textContent='ì €ì¥ë¨(í´ë¼ìš°ë“œ)'; alert('ì €ì¥ ì™„ë£Œ! (í´ë¼ìš°ë“œ)'); })
      .catch(function(e){ statusDaily.textContent='ì˜¤ë¥˜'; alert('ì €ì¥ ì‹¤íŒ¨: '+e); }); }
    else{ statusDaily.textContent='ì €ì¥ë¨(ë¡œì»¬)'; alert('ì €ì¥ ì™„ë£Œ!'); }
  }
  function clearDailyNow(){ if(!confirm('ì´ ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ëª¨ë‘ ì§€ìš¸ê¹Œìš”?')) return;
    var all=loadAll(); var key=dailyDate.value||ymd(new Date()); delete all.daily[key]; saveAll(all);
    var user=auth&&auth.currentUser; if(user&&db){ db.collection('users').doc(user.uid).collection('daily').doc(key).delete().catch(function(){}); }
    loadDaily(); statusDaily.textContent='ì‚­ì œë¨'; }

  // --- weekly ---
  function setWeekByDate(dt){
    var id=getWeekId(dt); if(weekPicker) weekPicker.value=id;
    if(weekText) weekText.textContent=weekPretty(id);
    if(weekTextNice) weekTextNice.textContent=weekOfMonthStr(dt);
    loadWeekly();
  }
  function shiftWeek(n){
    var val=weekPicker && weekPicker.value ? weekPicker.value : getWeekId(new Date());
    var sp=val.split('-W'); var y=parseInt(sp[0],10); var w=parseInt(sp[1],10);
    var base=new Date(Date.UTC(y,0,1+(w-1)*7)); base.setUTCDate(base.getUTCDate()+n*7);
    setWeekByDate(new Date(base));
  }
  function renderMissions(items){
    var missionList=$("#missionList"); missionList.innerHTML='';
    items=(items||[]); items.forEach(function(m,idx){
      var row=document.createElement('div'); row.className='mission-item';
      var cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!m.done; cb.addEventListener('change', function(){ m.done=cb.checked; saveWeeklyData(); });
      var txt=document.createElement('input'); txt.type='text'; txt.value=m.text||''; txt.placeholder='ë¯¸ì…˜ ë‚´ìš©'; txt.addEventListener('input', function(){ m.text=txt.value; });
      var del=document.createElement('button'); del.className='btn danger'; del.textContent='ì‚­ì œ';
      del.addEventListener('click', function(){ if(!confirm('ì‚­ì œí• ê¹Œìš”?'))return; items.splice(idx,1); renderMissions(items); saveWeeklyData(); });
      row.appendChild(cb); row.appendChild(txt); row.appendChild(del); missionList.appendChild(row);
    });
  }
  function currentWeekKey(){ return weekPicker && weekPicker.value ? weekPicker.value : getWeekId(new Date()); }
  function loadWeekly(){
    var key=currentWeekKey(); var w=null; var user=auth && auth.currentUser;
    function fill(w){ w=w||{missions:[],healing:''}; renderMissions(w.missions||[]); var ht=$("#healingText"); if(ht){ ht.value=w.healing||''; bindAuto(ht); } }
    if(user && db){ db.collection('users').doc(user.uid).collection('weekly').doc(key).get().then(function(s){ w=s.exists?s.data():null; if(!w){ var data=loadAll(); w=data.weekly[key]||null; } fill(w); })
      .catch(function(){ var data=loadAll(); w=data.weekly[key]||null; fill(w); });
    }else{ var data=loadAll(); w=data.weekly[key]||null; fill(w); }
  }
  function collectMissions(){ var rows=document.querySelectorAll('#missionList .mission-item'); var out=[];
    rows.forEach(function(r){ var cb=r.querySelector('input[type="checkbox"]'); var txt=r.querySelector('input[type="text"]'); var t=(txt&&txt.value||'').trim(); if(t) out.push({text:t,done:cb&&cb.checked}); });
    return out;
  }
  function saveWeeklyData(){
    var key=currentWeekKey(); var all=loadAll(); var ht=$("#healingText"); var heal=ht?ht.value.trim():'';
    all.weekly[key]={ missions:collectMissions(), healing:heal, updatedAt:new Date().toISOString() }; saveAll(all);
    var user=auth && auth.currentUser; if(user&&db){ db.collection('users').doc(user.uid).collection('weekly').doc(key).set(all.weekly[key],{merge:true}); }
  }

  // --- search & backup ---
  function doSearch(){
    var q=$("#searchInput").value.trim().toLowerCase(); var res=$("#searchResults"); res.innerHTML='';
    if(!q){ res.textContent='ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
    var all=loadAll(); var out=[];
    function pushIf(k,d){ var text=[d.question,d.answer,d.event,d.thought,d.feeling,d.result,d.note,(d.tags||[]).join(' ')].join(' ').toLowerCase(); if(text.indexOf(q)>=0) out.push({when:k,data:d}); }
    Object.keys(all.daily).forEach(function(k){ pushIf(k,all.daily[k]); });
    res.innerHTML = out.length ? out.map(function(x){ return '<div class="search-item"><b>'+x.when+'</b> â€” '+(x.data.note||x.data.answer||'')+'</div>'; }).join('') : 'ê²°ê³¼ ì—†ìŒ';
  }
  function exportJSON(){ var data=loadAll(); var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='thanks-diary-backup.json'; a.click(); }
  function importJSON(){ var f=$("#importFile"); if(!f || !f.files || !f.files[0]){ alert('ê°€ì ¸ì˜¬ JSON íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
    var reader=new FileReader(); reader.onload=function(){ try{ var obj=JSON.parse(reader.result); if(!obj || !obj.daily || !obj.weekly) throw 'í˜•ì‹ ì˜¤ë¥˜'; saveAll(obj); alert('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ'); }catch(e){ alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: '+e); } }; reader.readAsText(f.files[0]); }
  async function shareJSON(){ try{ var data=loadAll(); var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); var file=new File([blob],'thanks-diary-backup.json',{type:'application/json'});
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({files:[file], title:'ì§€ë‹ˆì§± ê°ì‚¬ì¼ê¸° ë°±ì—…', text:'ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.'}); }
    else{ exportJSON(); alert('ê³µìœ  APIë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ íŒŒì¼ ë‹¤ìš´ë¡œë“œë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.'); }
  }catch(e){ alert('ê³µìœ  ì‹¤íŒ¨/ì·¨ì†Œ: '+e); } }

  // --- auth modal ---
  var lm, loginEmail, loginPwd, loginMsg;
  function openModal(){ if(lm){ lm.classList.add('open'); loginMsg.textContent=''; } }
  function closeModal(){ if(lm){ lm.classList.remove('open'); } }
  function signIn(){ if(!firebaseReady){ alert('Firebaseê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.'); return; }
    var email=(loginEmail&&loginEmail.value)||'', pwd=(loginPwd&&loginPwd.value)||'';
    auth.signInWithEmailAndPassword(email.trim(), pwd).then(function(){ closeModal(); })
      .catch(function(e){ var m='ë¡œê·¸ì¸ ì‹¤íŒ¨: '+(e && e.message ? e.message : e); loginMsg.textContent=m; alert(m); });
  }
  function signUp(){ if(!firebaseReady){ alert('Firebaseê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
    var email=(loginEmail&&loginEmail.value)||'', pwd=(loginPwd&&loginPwd.value)||'';
    auth.createUserWithEmailAndPassword(email.trim(), pwd).then(function(){ closeModal(); })
      .catch(function(e){ var m='íšŒì›ê°€ì… ì‹¤íŒ¨: '+(e && e.message ? e.message : e); loginMsg.textContent=m; alert(m); });
  }
  window.TD_openLogin=openModal; window.TD_closeLogin=closeModal; window.TD_signIn=signIn; window.TD_signUp=signUp;

  // --- wire clicks (defensive) ---
  document.addEventListener('click', function(e){
    var id=e && e.target && e.target.id;
    if(id==='tab-daily'||id==='tab-weekly'||id==='tab-search'||id==='tab-settings'){ /* hash anchors handle */ }
    if(id==='prevDay') shiftDaily(-1);
    if(id==='nextDay') shiftDaily(1);
    if(id==='todayBtn') setDailyDate(new Date());
    if(id==='btnAnotherQ'){ questionText.value=nextFromPool('q',questionPool); autoResize(questionText); }
    if(id==='saveDaily') saveDailyNow();
    if(id==='clearDaily') clearDailyNow();
    if(id==='prevWeek') shiftWeek(-1);
    if(id==='nextWeek') shiftWeek(1);
    if(id==='thisWeekBtn') setWeekByDate(new Date());
    if(id==='addMission'){ var nt=$("#newMission").value.trim(); if(!nt) return; var all=loadAll(); var k=currentWeekKey(); var w=all.weekly[k]||{missions:[],healing:''}; w.missions.push({text:nt,done:false}); all.weekly[k]=w; saveAll(all); $("#newMission").value=''; renderMissions(w.missions); saveWeeklyData(); }
    if(id==='saveWeekly'){ saveWeeklyData(); alert('ì£¼ê°„ ë°ì´í„° ì €ì¥ ì™„ë£Œ'); }
    if(id==='clearWeekly'){ if(!confirm('ì´ ì£¼ì°¨ì˜ ì£¼ê°„ ë°ì´í„°ë¥¼ ëª¨ë‘ ì§€ìš¸ê¹Œìš”?')) return; var all=loadAll(); var k=currentWeekKey(); delete all.weekly[k]; saveAll(all); var u=auth&&auth.currentUser; if(u&&db){ db.collection('users').doc(u.uid).collection('weekly').doc(k).delete().catch(function(){});} loadWeekly(); }
    if(id==='randomHealing'){ var ht=$("#healingText"); if(ht){ ht.value=nextFromPool('h',healingPool); autoResize(ht); } }
    if(id==='startCopy'){ var c=$("#copyArea"); if(!c) return; c.classList.toggle('hidden'); if(!c.classList.contains('hidden')){ c.value=$("#healingText").value; autoResize(c); } }
    if(id==='searchBtn') doSearch();
    if(id==='searchClear'){ var si=$("#searchInput"); if(si) si.value=''; var sr=$("#searchResults"); if(sr) sr.innerHTML=''; }
    if(id==='exportJSON') exportJSON();
    if(id==='shareJSON') shareJSON();
    if(id==='importJSON') importJSON();
    if(id==='refreshCache'){ alert('ì„œë¹„ìŠ¤ì›Œì»¤ ì—†ì´ ë™ì‘í•©ë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•˜ë©´ ìµœì‹  ì ìš©ë©ë‹ˆë‹¤.'); }
    if(id==='resetLocal'){ if(!confirm('ë¡œì»¬ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return; localStorage.removeItem(storeKey); alert('ë¡œì»¬ ë°ì´í„° ì‚­ì œ ì™„ë£Œ'); }
    if(id==='authMiniLogout' || id==='btnSignOut'){ if(auth) auth.signOut(); }
    if(id==='openLogin' || id==='authMiniLogin') openModal();
    if(id==='modalClose') closeModal();
    if(id==='modalSignIn') signIn();
    if(id==='modalSignUp') signUp();
  });

  // --- init ---
  function init(){
    grab();
    if(!location.hash) location.hash='#/daily';
    onHash(); window.addEventListener('hashchange', onHash);
    var d=new Date();
    if(dailyDate){ dailyDate.value=ymd(d); dailyDateText.textContent=formatDatePretty(dailyDate.value); }
    setWeekByDate(d); loadDaily();

    if(firebaseReady){
      auth.onAuthStateChanged(function(user){
        var miniState=$("#authMiniState"), miniLogin=$("#authMiniLogin"), miniLogout=$("#authMiniLogout");
        if(miniState) miniState.textContent = user? 'ë¡œê·¸ì¸ë¨':'ë¡œê·¸ì•„ì›ƒ ìƒíƒœ';
        if(miniLogin) miniLogin.classList.toggle('hidden', !!user);
        if(miniLogout) miniLogout.classList.toggle('hidden', !user);
        var node=$("#authState"); if(node) node.textContent = user ? ('ë¡œê·¸ì¸ë¨: '+(user.email||user.uid)) : 'ë¡œê·¸ì•„ì›ƒ ìƒíƒœ';
      });
    }

    // ìºì‹œ/ì„œë¹„ìŠ¤ì›Œì»¤ ì œê±°(ë‚¨ì•„ìˆë‹¤ë©´)
    if('serviceWorker' in navigator){
      navigator.serviceWorker.getRegistrations().then(function(rs){ rs.forEach(function(r){ r.unregister(); }); });
      if(window.caches && caches.keys) caches.keys().then(function(keys){ keys.forEach(function(k){ caches.delete(k); }); });
    }
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
})();

  </script>
</body>
</html>
